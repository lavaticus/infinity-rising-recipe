<!DOCTYPE html>
<html>
<head>
    <title>Infinity Rising: Crafting</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; padding: 0; margin: 0; }
    
    /* Fixed Header to keep branding visible while scrolling */
    .header { 
        position: fixed; /* Keeps header at top */
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000; /* Ensures it stays above recipes */
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 15px 40px; 
        background: rgba(17, 17, 17, 0.95); /* Slight transparency for style */
        border-bottom: 2px solid #c9a84c;
        box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }

    /* THE FIX: Pushing the content down so it doesn't collide */
    .container { 
        padding: 140px 40px 40px 40px; /* Top padding increased to clear header */
    }

    .game-logo { height: 60px; }
    
    .guild-branding { 
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .guild-logo { 
        height: 45px; 
        margin-top: 5px;
        filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.1));
    }

    .guild-text { 
		margin: 0;
		padding: 0;
        font-size: 0.65em; 
        color: #c9a84c; 
        text-transform: uppercase; 
        letter-spacing: 2px;
        font-weight: bold;
    }
	
	.source-label {
		font-size: 0.65em;
		color: #00d4ff;
		background: rgba(0, 212, 255, 0.1);
		border-radius: 4px;
		padding: 8px; /* Increased padding for better look with multiple lines */
		margin-top: 8px;
		display: inline-block;
		border: 1px solid rgba(0, 212, 255, 0.3);
    
		/* THIS IS THE MAGIC LINE */
		white-space: pre-line; 
    
		text-align: left; /* Aligns the bullet points to the left */
		max-width: 140px; /* Prevents the box from getting too wide */
	}

    /* Rest of your recipe styles... */
    #recipe-view { 
        display: none; 
        background: #262626; 
        border: 2px solid #c9a84c; 
        padding: 30px; 
        border-radius: 15px; 
        margin-bottom: 40px; 
        text-align: center;
        animation: fadeIn 0.4s ease-out;
    }
	
	.filter-bar {
		display: flex;
		justify-content: center;
		gap: 10px;
		margin-bottom: 30px;
		flex-wrap: wrap;
	}

	.filter-btn {
		background: #262626;
		border: 1px solid #333;
		color: #888;
		padding: 8px 20px;
		border-radius: 20px;
		cursor: pointer;
		transition: 0.3s;
		font-size: 0.9em;
		text-transform: uppercase;
		letter-spacing: 1px;
	}

	.filter-btn:hover { border-color: #c9a84c; color: white; }

	.filter-btn.active {
		background: #c9a84c;
		color: #1a1a1a;
		border-color: #c9a84c;
		font-weight: bold;
	}

	/* Styling for your new overview section */
	#recipe-overview-container {
		margin-top: 50px;
		background: #1a1a1a;
		padding: 20px;
		border-radius: 8px;
		border: 1px solid #333;
		overflow-x: auto; /* Allow scrolling for large trees */
	}
	.mermaid {
		background-color: transparent !important;
	}
		
	.crafting-flow { display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; }
    .operator { font-size: 24px; color: #c9a84c; font-weight: bold; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
    .card { background: #262626; border: 1px solid #333; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; }
    .card:hover { border-color: #c9a84c; transform: translateY(-5px); }
    img.item-img { width: 80px; height: 80px; object-fit: contain; }
    .ingredient-card { background: #333; padding: 10px; border-radius: 8px; width: 110px; }	
	
    </style>
</head>
<body>

    <div class="header">
		<img id="game-logo-img" class="game-logo" src="" alt="Infinity Rising">
    
		<div class="guild-branding">
			<div style="display: flex; align-items: center; gap: 20px;">
        
				<a href="https://discord.gg/knights-of-cornucopias" target="_blank" rel="noopener noreferrer" style="display: flex; align-items: center;">
					<img id="discord-icon" src="" alt="Discord" 
						style="height: 28px; width: auto; opacity: 0.9; vertical-align: middle;">
				</a>

				<div style="height: 30px; width: 1px; background: rgba(0, 212, 255, 0.3);"></div>

				<div style="display: flex; flex-direction: column; align-items: flex-end; gap: 2px;">
					<span class="guild-text" style="line-height: 1;">Crafting Database By</span>
					<a href="https://knightsguild.co/" target="_blank" rel="noopener noreferrer" 
					style="text-decoration: none; display: block; line-height: 0;">
						<img id="guild-logo-img" class="guild-logo" src="" alt="Knights Guild" 
							style="height: 48px; object-fit: contain;">
					</a>
				</div>

			</div>
		</div>
	</div>

    <div class="container">
		<div class="filter-bar" id="filter-bar">
			<button class="filter-btn active" onclick="filterCategory('All', this)">All</button>
			<button class="filter-btn" onclick="filterCategory('Food/Drink', this)">Food/Drink</button>
			<button class="filter-btn" onclick="filterCategory('Medicine', this)">Medicine</button>
		</div>
        <div id="recipe-view">
            <h2 id="view-title" style="margin-top: 0; color: #00d4ff;"></h2>
            <div id="crafting-tree" class="crafting-flow"></div>
        </div>

        <div id="recipe-grid" class="grid"></div>
    </div>

	<!-- Load Mermaid from CDN -->
	<script type="module">
		import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
		mermaid.initialize({ startOnLoad: false }); // We will trigger it manually
	</script>
	
    <script>
    const SB_URL = "https://yuxcjrzzjsyzdjrftezb.supabase.co";
    const SB_KEY = "sb_publishable_lE_J5fElNPX8AU6IvjJBUA_h_Lywrgo";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let ingredientsMaster = [];
    let allRecipeCards = []; 

    // Branding
    const assetBaseUrl = `${SB_URL}/storage/v1/object/public/game-assets/website`;
    document.getElementById('game-logo-img').src = `${assetBaseUrl}/IR_Logo_Main_01.png`;
    document.getElementById('guild-logo-img').src = `${assetBaseUrl}/knoc-logo-colour.png`;
    document.getElementById('discord-icon').src = `${assetBaseUrl}/discord-mark-white.webp`;

	async function showCraftingTree(recipe, outputItem) {
		const view = document.getElementById('recipe-view');
		const tree = document.getElementById('crafting-tree');
		document.getElementById('view-title').innerText = outputItem.name;
		view.style.display = 'block';
		tree.innerHTML = "";

		const ingredientsNeeded = Object.entries(recipe.ingredients_required);
    
		// Check if ingredient is also a product in the recipes table
		const { data: allRecipes } = await _supabase.from('recipes').select('*');

		ingredientsNeeded.forEach(([slug, qty], index) => {
			const data = ingredientsMaster.find(i => i.slug === slug);
			const img = `${SB_URL}/storage/v1/object/public/game-assets/${data?.image_path}`;
			const sourceInfo = data?.source || "Unknown Source";

			// Logic to find if this ingredient has its own recipe
			const subRecipe = allRecipes.find(r => {
				const product = ingredientsMaster.find(i => i.id === r.output_item_id);
				return product?.slug === slug;
			});
	
			const card = document.createElement('div');
			card.className = 'ingredient-card';
        
			// Restore your original compact HTML structure for the source field
			card.innerHTML = `
				<img class="item-img" src="${img}">
				<div style="font-weight: bold;">${qty}x ${data?.name || slug}</div>
            
				${subRecipe ? `
					<div style="margin: 5px 0;">
						<button class="filter-btn active" style="font-size: 10px; padding: 2px 8px; cursor: pointer;">
							üõ†Ô∏è CRAFTABLE
						</button>
					</div>
				` : ''}

				<div class="source-label">${sourceInfo}</div>
			`;

			// If it's craftable, make the whole card a link to its recipe
			if (subRecipe) {
				card.style.cursor = "pointer";
				card.style.border = "1px solid #c9a84c"; // Optional: gold border for craftable items
				card.onclick = () => showCraftingTree(subRecipe, data);
			}

			tree.appendChild(card);

			if (index < ingredientsNeeded.length - 1) {
				const op = document.createElement('div');
				op.className = 'operator';
				op.innerText = '+';
				tree.appendChild(op);
			}
		});

		// Final Product Result
		const finalImg = `${SB_URL}/storage/v1/object/public/game-assets/${outputItem.image_path}`;
		const resultHtml = `
			<div class="operator">=</div>
			<div class="ingredient-card" style="border: 1px solid #c9a84c;">
				<img class="item-img" src="${finalImg}">
				<div>${outputItem.name}</div>
			</div>
		`;
		tree.insertAdjacentHTML('beforeend', resultHtml);
		window.scrollTo({top: 0, behavior: 'smooth'});
	}

    async function loadWiki() {
        const { data: ingredients } = await _supabase.from('ingredients').select('*');
        const { data: recipes } = await _supabase.from('recipes').select('*');
        ingredientsMaster = ingredients;
        const grid = document.getElementById('recipe-grid');
        grid.innerHTML = ""; // Clear grid before loading

        recipes.forEach(recipe => {
            const item = ingredientsMaster.find(i => i.id === recipe.output_item_id);
            if (!item) return;

            const card = document.createElement('div');
            card.className = 'card';
            // Use 'All' if the category in the database is null or empty
            card.dataset.category = item.category || 'All'; 
            card.onclick = () => showCraftingTree(recipe, item);
            
            const imgUrl = `${SB_URL}/storage/v1/object/public/game-assets/${item.image_path}`;
            card.innerHTML = `<img class="item-img" src="${imgUrl}"><h3 style="color:#00d4ff">${item.name}</h3>`;
            
            grid.appendChild(card);
            allRecipeCards.push(card);
        });

    // --- ADDED THIS LINE BELOW ---
    // This triggers the diagram to draw once the data is ready
    generateRecipeTree(); 
    }

    function filterCategory(category, btn) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        allRecipeCards.forEach(card => {
            // Logic: Show if 'All' is selected OR if card matches category exactly
            if (category === 'All' || card.dataset.category === category) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
        document.getElementById('recipe-view').style.display = 'none';
    }

    // THE VITAL MISSING LINE:
    loadWiki(); 
	
async function generateRecipeTree() {
    const graphDiv = document.getElementById('mermaid-graph');
    if (!ingredientsMaster.length) return; // Wait if data isn't ready

    // 1. Build the graph string
    let graphDefinition = "graph LR\n";
    const { data: recipes } = await _supabase.from('recipes').select('*');

    recipes.forEach(recipe => {
        const outputItem = ingredientsMaster.find(i => i.id === recipe.output_item_id);
        if (!outputItem) return;

        Object.entries(recipe.ingredients_required).forEach(([slug, qty]) => {
            const ingredientData = ingredientsMaster.find(i => i.slug === slug);
            const ingredientName = ingredientData?.name || slug;
            graphDefinition += `  "${ingredientName}" -- "${qty}x" --> "${outputItem.name}"\n`;
        });
    });

    // 2. Render with explicit Dark Theme
    import('https://cdn.jsdelivr.net').then(async (mermaid) => {
        mermaid.default.initialize({ 
            startOnLoad: false, 
            theme: 'dark', // Forces white text/lines for dark backgrounds
            securityLevel: 'loose' 
        });
        
        try {
            const { svg } = await mermaid.default.render('graph-unique-id', graphDefinition);
            graphDiv.innerHTML = svg;
        } catch (err) {
            console.error("Mermaid Render Error:", err);
            graphDiv.innerHTML = "<p style='color:red;'>Error drawing tech tree. check console.</p>";
        }
    });
}



    </script>
	


<div id="recipe-overview-container">
    <h2 style="color:#00d4ff; text-align: center;">Crafting Tech Tree</h2>
    <div id="mermaid-graph" class="mermaid"></div>
</div>


</body>
</html>